name: Initiate new vote

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    paths:
      - votes/initiateNewVote/_EDIT_ME.yml
  push:
    branches:
      - initiateNewVote

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false

jobs:
  initiate-new-vote:
    if: github.event.pusher
    permissions:
      contents: write
      pull-requests: write
      repository-projects: read
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@a5ac7e51b41094c92402da3b24376905380afc29  # v4.1.6
        with:
          fetch-depth: 3
      - name: Install ghcommit
        run: go install github.com/planetscale/ghcommit@840639dc8f8aa7236d987a3074781b79cb304fbc
      - name: Configure git
        run: |
          git config --global user.email "github-bot@iojs.org"
          git config --global user.name "Node.js GitHub Bot"
      - name: Push revert
        run: |
          set -x
          if [[ "0" == "0" ]]; then
            git reset ${{ github.sha }}^ --hard
            git revert HEAD --no-edit
            GH_COMMIT_PATH="$(go env GOPATH)/bin/ghcommit" COMMIT_MESSAGE="$(
              git log -1 HEAD --pretty=format:%B
            )" DELETED_FILES="$(
              git show HEAD --name-only --diff-filter=D --pretty=format:
            )" ADDED_FILES="$(
              git show HEAD --name-only --diff-filter=d --pretty=format:
            )" node --input-type=module <<'EOF'
              import { spawnSync } from "node:child_process";
              const {GH_COMMIT_PATH, COMMIT_MESSAGE, DELETED_FILES, ADDED_FILES} = process.env;
              console.log(GH_COMMIT_PATH, [
                '-r', ${{ toJSON(github.repository) }},
                '-b', 'initiateNewVote',
                '-m', COMMIT_MESSAGE,
                '--sha', ${{ toJSON(github.sha) }},
                ...DELETED_FILES.split('\n').filter(Boolean).flatMap(file => ['--delete', file]),
                ...ADDED_FILES.split('\n').filter(Boolean).flatMap(file => ['--add', file]),
              ], { stdio: 'inherit' });
              spawnSync(GH_COMMIT_PATH, [
                '-r', ${{ toJSON(github.repository) }},
                '-b', 'initiateNewVote',
                '-m', COMMIT_MESSAGE,
                '--sha', ${{ toJSON(github.sha) }},
                ...DELETED_FILES.split('\n').filter(Boolean).flatMap(file => ['--delete', file]),
                ...ADDED_FILES.split('\n').filter(Boolean).flatMap(file => ['--add', file]),
              ], { stdio: 'inherit' });
          EOF
          fi
        env:
          GITHUB_TOKEN: ${{ github.token }}
